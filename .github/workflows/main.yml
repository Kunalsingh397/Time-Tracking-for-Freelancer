name: MERN Stack CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
      
env:
  NODE_VERSION: '20'

jobs:
  # 1. Build & Prepare (CI)
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # 1.1. Backend (Server) Setup
      - name: Setup Node.js for Backend & Install Dependencies
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install Backend Dependencies
        run: npm install
        working-directory: ./backend
        
      # 1.2. Frontend (Client) Setup
      - name: Setup Node.js for Frontend & Install Dependencies
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Frontend Dependencies
        run: npm install
        working-directory: ./client
        
      - name: Build Frontend (React)
        run: npm run build
        working-directory: ./client
        
      # --- DEPLOYMENT PREPARATION STEPS ---
      
      - name: 1.3.1. Move Frontend Build into Backend (for EB deployment)
        # Assuming your Express server serves static files from 'backend/client/build' or 'backend/build'
        run: mv client/build backend/client-build
        # Note: You need to configure your Express server (in backend/server.js) to serve static files from './client-build'.
        
      - name: 1.3.2. Create Deployment Package (ZIP)
        # Create a ZIP file of the backend folder (which now contains the React build)
        run: zip -r deploy_package.zip backend
        
      # 1.4. Upload Deployment Artifact
      - name: Upload Deployment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deploy_package.zip
          
  # 2. Deployment (CD)
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Download Deployment Package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: .
          
      # AWS Elastic Beanstalk (EB) Deployment
      - name: Deploy to AWS Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: your-app-name-here # <--- CHANGE THIS
          environment_name: your-environment-name-here # <--- CHANGE THIS
          region: ap-south-1 # <--- CHANGE THIS
          version_label: ${{ github.sha }}
          deployment_package: deploy_package.zip # <-- Now deploying the ZIP file
